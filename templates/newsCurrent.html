<!-- templates/newsCurrent.html -->
{% extends "base.html" %}

{% block content %}
<style>
  /* === CLEAN BLACK & WHITE SOC THEME === */
  body {
    background-color: #ffffff !important;
    color: #000000 !important;
  }

  /* Header: keep blue accent for branding */
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: #ffffff !important;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  /* Search filter card */
  .filter-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
  }
  
  .filter-card .form-label {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.9rem;
  }
  
  .filter-card .form-select,
  .filter-card .form-control {
    border: 1px solid #cbd5e1;
    border-radius: 8px;
  }
  
  .filter-card .form-select:focus,
  .filter-card .form-control:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
  }
  
  .btn-filter {
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 20px;
    font-weight: 600;
  }
  
  .btn-filter:hover {
    background: #4338ca;
  }
  
  .btn-reset {
    background: #94a3b8;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 20px;
    font-weight: 600;
  }
  
  .btn-reset:hover {
    background: #64748b;
  }

  /* Date range container */
  .date-range-container {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
  }
  
  .date-range-container .form-label {
    font-size: 0.8rem;
    margin-bottom: 4px;
  }

  /* Active filter badge */
  .active-filter-badge {
    background: #f1f5f9;
    border: 1px solid #cbd5e1;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    color: #475569;
  }
  
  .active-filter-badge .close-filter {
    color: #94a3b8;
    text-decoration: none;
    margin-left: 8px;
    font-size: 1.2rem;
    line-height: 1;
  }
  
  .active-filter-badge .close-filter:hover {
    color: #ef4444;
  }

  /* === TABLE: BLACK & WHITE === */
  .table-soc {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    color: #000000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .table-soc thead th {
    background: #f8fafc;
    color: #1e293b;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.82rem;
    letter-spacing: 1px;
    border-bottom: 2px solid #cbd5e1;
    padding: 14px 16px;
  }

  .table-soc tbody tr {
    border-bottom: 1px solid #e2e8f0;
    background: #ffffff;
    transition: all 0.2s ease;
  }

  .table-soc tbody tr:nth-child(even) {
    background: #f8fafc;
  }

  .table-soc tbody tr:hover {
    background: #f1f5f9 !important;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* âœ… Black text on white â€” maximum readability */
  .table-soc tbody td {
    padding: 14px 16px;
    vertical-align: middle;
    color: #000000;
    font-size: 0.95rem;
    font-weight: 500;
  }

  /* === BADGES: GRAYSCALE WITH STATUS HIGHLIGHT === */
  .badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 600;
    min-width: 90px;
    text-align: center;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    color: white;
    border: 1px solid transparent;
  }

  .badge-pending { 
    background: #f59e0b; 
    color: #1e293b; 
    font-weight: 700;
  }
  .badge-completed { 
    background: #10b981; 
    color: white; 
  }
  .badge-cancelled { 
    background: #ef4444; 
    color: white; 
  }
  .badge.bg-secondary { 
    background: #94a3b8; 
    color: white; 
  }

  /* Status accent border (subtle) */
  tr[data-status="pending"] { border-left: 4px solid #f59e0b; }
  tr[data-status="completed"] { border-left: 4px solid #10b981; }
  tr[data-status="cancelled"] { border-left: 4px solid #ef4444; }
  tr[data-status="unknown"],
  tr:not([data-status]) { border-left: 4px solid #94a3b8; }

  /* Brief text â€“ clean link */
  .brief-text {
    cursor: pointer;
    color: #4f46e5;
    text-decoration: none;
    font-weight: 600;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background 0.2s ease;
  }
  .brief-text:hover {
    background: #f1f5f9;
    color: #4338ca;
  }

  /* === PAGINATION === */
  .pagination .page-link {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    color: #4f46e5;
    margin: 0 4px;
    border-radius: 8px;
  }
  .pagination .page-link:hover {
    background: #f1f5f9;
    border-color: #4f46e5;
    color: #4338ca;
  }
  .pagination .page-item.active .page-link {
    background: #4f46e5;
    border-color: #4f46e5;
    color: white;
    font-weight: 600;
  }

  /* === EMPTY STATE === */
  .empty-state {
    color: #64748b;
    font-style: italic;
    padding: 40px 20px;
    text-align: center;
    font-size: 1.1rem;
  }
  .empty-state i {
    color: #94a3b8;
  }

  /* === MODAL === */
  .modal-content {
    background: #ffffff;
    color: #000000;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  }
  .modal-header, .modal-footer {
    border-color: #e2e8f0;
  }
  .modal-title {
    color: #1e293b;
    font-weight: 700;
  }
  .modal-body hr {
    border-color: #e2e8f0;
  }
</style>

<div class="container-fluid">
  <!-- ðŸ”µ Header (keep blue for visual anchor) -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 bg-gradient-primary text-white">
        <div class="card-body py-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h3 mb-2">
                <i class="fas fa-shield-alt me-2"></i>CURRENT INTELLIGENCE FEED
              </h1>
              <p class="mb-0 opacity-90">
                Real-time operational updates from field units
              </p>
            </div>
            <div class="col-md-4 text-md-end">
              <span class="badge bg-white text-dark fs-6">
                <i class="fas fa-database me-1"></i>
                {{ total_count }} Active Reports
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ” Search & Filter Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="filter-card">
        <form method="GET" action="" class="row g-3 align-items-end">
          <!-- Search Field -->
          <div class="col-md-3">
            <label class="form-label">Search Reports</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" name="search" 
                     placeholder="Search reports..." 
                     value="{{ search }}">
            </div>
          </div>
          
          <!-- Province Filter -->
          <div class="col-md-2">
            <label class="form-label">Province</label>
            <select class="form-select" name="province">
              <option value="">All Provinces</option>
              <option value="koshi" {% if province == 'koshi' %}selected{% endif %}>Koshi</option>
              <option value="madhesh" {% if province == 'madhesh' %}selected{% endif %}>Madhesh</option>
              <option value="bagmati" {% if province == 'bagmati' %}selected{% endif %}>Bagmati</option>
              <option value="gandaki" {% if province == 'gandaki' %}selected{% endif %}>Gandaki</option>
              <option value="lumbini" {% if province == 'lumbini' %}selected{% endif %}>Lumbini</option>
              <option value="karnali" {% if province == 'karnali' %}selected{% endif %}>Karnali</option>
              <option value="sudurpaschim" {% if province == 'sudurpaschim' %}selected{% endif %}>Sudurpaschim</option>
            </select>
          </div>
          
          <!-- Status Filter -->
          <div class="col-md-2">
            <label class="form-label">Status</label>
            <select class="form-select" name="status">
              <option value="">All Status</option>
              <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
              <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
          </div>
          
          <!-- Date Range Filter -->
          <div class="col-md-4">
            <label class="form-label">Date Range</label>
            <div class="date-range-container">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">From</label>
                  <input type="date" class="form-control" name="start_date" 
                         value="{{ start_date }}">
                </div>
                <div class="col-6">
                  <label class="form-label small">To</label>
                  <input type="date" class="form-control" name="end_date" 
                         value="{{ end_date }}">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="col-md-1">
            <button type="submit" class="btn btn-filter w-100">
              <i class="fas fa-filter me-1"></i> Filter
            </button>
          </div>
        </form>
        
        <!-- Active Filters Display - FIXED SECTION -->
        {% if search or province or status or start_date or end_date %}
        <div class="mt-3 pt-3 border-top">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <small class="fw-medium">Active Filters:</small>
            
            {% if search %}
            <span class="active-filter-badge">
              Search: "{{ search }}"
              <a href="#" onclick="removeFilter('search')" class="close-filter">&times;</a>
            </span>
            {% endif %}
            
            {% if province %}
            <span class="active-filter-badge">
              Province: {{ province|title }}
              <a href="#" onclick="removeFilter('province')" class="close-filter">&times;</a>
            </span>
            {% endif %}
            
            {% if status %}
            <span class="active-filter-badge">
              Status: {{ status|title }}
              <a href="#" onclick="removeFilter('status')" class="close-filter">&times;</a>
            </span>
            {% endif %}
            
            {% if start_date and end_date %}
            <span class="active-filter-badge">
              Date: {{ start_date }} to {{ end_date }}
              <a href="#" onclick="removeBothDates()" class="close-filter">&times;</a>
            </span>
            {% elif start_date %}
            <span class="active-filter-badge">
              From: {{ start_date }}
              <a href="#" onclick="removeFilter('start_date')" class="close-filter">&times;</a>
            </span>
            {% elif end_date %}
            <span class="active-filter-badge">
              To: {{ end_date }}
              <a href="#" onclick="removeFilter('end_date')" class="close-filter">&times;</a>
            </span>
            {% endif %}
            
            <a href="?" class="btn-reset btn-sm">
              <i class="fas fa-times me-1"></i> Clear All
            </a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Intel Table -->
  <div class="row">
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-soc align-middle">
          <thead>
            <tr>
              <th scope="col">SN</th>
              <th scope="col">TIMESTAMP</th>
              <th scope="col">Province</th>
              <th scope="col">LOCATION</th>
              <th scope="col">LEADER</th>
              <th scope="col">People</th>
              <th scope="col">VEHICLE</th>
              <th scope="col">STATUS</th>
              <th scope="col">BRIEF</th>
              <th scope="col">CREATED</th>
            </tr>
          </thead>
          <tbody>
            {% for item in page_obj %}
            <tr data-status="{{ item.status|default:'unknown' }}">
              <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td>{{ item.timing }}</td>
              <td>
                {% if item.province %}
                <span class="badge bg-light text-dark border">
                  {{ item.province }}
                </span>
                {% else %}
                â€”
                {% endif %}
              </td>
              <td>{{ item.location }}</td>
              <td>{{ item.leader }}</td>
              <td>{{ item.number|default:"â€”" }}</td>
              <td>{{ item.vehicle|default:"â€”" }}</td>
              <td>
                {% if item.status == 'pending' %}
                  <span class="badge badge-pending">PENDING</span>
                {% elif item.status == 'completed' %}
                  <span class="badge badge-completed">COMPLETED</span>
                {% elif item.status == 'cancelled' %}
                  <span class="badge badge-cancelled">CANCELLED</span>
                {% else %}
                  <span class="badge bg-secondary">UNKNOWN</span>
                {% endif %}
              </td>
              <td>
                {% if item.description %}
                  <span class="brief-text" data-bs-toggle="modal" data-bs-target="#descModal{{ item.id }}">
                    {{ item.description|truncatewords:15 }}
                  </span>
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td>
                <small class="text-muted" title="{{ item.created_at }}">
                  {{ item.created_at|date:"M d, Y" }}
                </small>
              </td>
            </tr>

            <!-- Modal -->
            <div class="modal fade" id="descModal{{ item.id }}" tabindex="-1">
              <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      <i class="fas fa-file-alt me-2"></i>INTEL REPORT â€” {{ item.leader }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>Location:</strong> {{ item.location }}</p>
                        <p><strong>Time:</strong> {{ item.timing }}</p>
                        <p><strong>Province:</strong> {{ item.province|default:"Not specified" }}</p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>Vehicle:</strong> {{ item.vehicle|default:"Not specified" }}</p>
                        <p><strong>Status:</strong> 
                          {% if item.status == 'pending' %}
                            <span class="badge badge-pending">PENDING</span>
                          {% elif item.status == 'completed' %}
                            <span class="badge badge-completed">COMPLETED</span>
                          {% elif item.status == 'cancelled' %}
                            <span class="badge badge-cancelled">CANCELLED</span>
                          {% endif %}
                        </p>
                        <p><strong>Created:</strong> {{ item.created_at|date:"Y-m-d H:i" }}</p>
                      </div>
                    </div>
                    <hr class="my-3">
                    <h6>Full Description:</h6>
                    <p style="white-space: pre-wrap; line-height: 1.5;">{{ item.description }}</p>
                  </div>
                  <div class="modal-footer">
                    <small class="text-muted">Report ID: {{ item.id }}</small>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <tr>
              <td colspan="10" class="text-center empty-state py-5">
                <i class="fas fa-satellite-dish fa-2x mb-3 d-block"></i>
                ðŸ“¡ NO REPORTS FOUND
                {% if search or province or status or start_date or end_date %}
                  <br><small class="text-muted mt-2 d-block">Try adjusting your filters</small>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination with preserved filters -->
      {% if page_obj.has_other_pages %}
      <nav aria-label="Intel Feed Navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if query_string %}&{{ query_string }}{% endif %}">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">
                <i class="fas fa-angle-left"></i>
              </a>
            </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if query_string %}&{{ query_string }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">
                <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<script>
// JavaScript functions for filter removal
function removeFilter(filterName) {
  const url = new URL(window.location.href);
  const params = new URLSearchParams(url.search);
  
  // Remove the specified filter
  params.delete(filterName);
  
  // Remove page parameter to go back to page 1
  params.delete('page');
  
  // Update URL and redirect
  url.search = params.toString();
  window.location.href = url.toString();
}

function removeBothDates() {
  const url = new URL(window.location.href);
  const params = new URLSearchParams(url.search);
  
  // Remove both date filters
  params.delete('start_date');
  params.delete('end_date');
  
  // Remove page parameter to go back to page 1
  params.delete('page');
  
  // Update URL and redirect
  url.search = params.toString();
  window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  // Set default dates if needed
  const endDateField = document.querySelector('input[name="end_date"]');
  const startDateField = document.querySelector('input[name="start_date"]');
  
  if (endDateField && !endDateField.value) {
    const today = new Date().toISOString().split('T')[0];
    endDateField.value = today;
  }
  
  if (startDateField && !startDateField.value) {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
    startDateField.value = thirtyDaysAgoStr;
  }
  
  // Also attach event listeners for better accessibility
  document.querySelectorAll('.close-filter').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      // The onclick handler will handle it
    });
  });
});
</script>

{% endblock %}