{% extends 'base.html' %}
{% load static %}

{% block title %}Nepal Government Websites Monitor{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header with Auto-refresh Note -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            <i class="fas fa-flag me-2 text-primary"></i>
            Nepal Government Websites Status Monitor
        </h4>
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-info" id="refresh-badge">
                <i class="fas fa-sync-alt me-1"></i> Auto-refresh: <span id="countdown">60</span>s
            </span>
            <span class="text-muted small">
               Last checked: {{ last_checked }}
            </span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-4 col-md-4">
            <div class="card shadow border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total Websites</h6>
                            <h3 class="fw-bold mb-0 text-primary">{{ total }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2">
                            <i class="fas fa-globe text-primary"></i>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-server me-1"></i>Government Portals
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-md-4">
            <div class="card shadow border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Online</h6>
                            <h3 class="fw-bold mb-0 text-success">{{ up_count }}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-2">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-chart-line me-1"></i>Accessible
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-md-4">
            <div class="card shadow border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Offline</h6>
                            <h3 class="fw-bold mb-0 text-danger">{{ down_count }}</h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 rounded-circle p-2">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-exclamation-circle me-1"></i>Requires attention
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-body p-3">
            <div class="row">
                <div class="col-md-8">
                    <form method="GET" action="" id="searchForm">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   name="search" 
                                   placeholder="ðŸ” Search websites by name or URL..." 
                                   value="{{ search_query }}"
                                   aria-label="Search websites"
                                   id="searchInput">
                            <button class="btn btn-outline-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                            {% if search_query %}
                                <a href="?" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="d-flex justify-content-end gap-2">
                        <span class="badge bg-success align-self-center">
                            <i class="fas fa-circle me-1"></i>Online: {{ up_count }}
                        </span>
                        <span class="badge bg-danger align-self-center">
                            <i class="fas fa-circle me-1"></i>Offline: {{ down_count }}
                        </span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAllWebsites()">
                            <i class="fas fa-sync-alt me-1"></i>Check Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Websites Table Card -->
    <div class="card shadow border-0">
        <div class="card-body p-3">
            {% if results %}
            <!-- Page Info -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <small class="text-muted">
                        Showing <strong>{{ results|length }}</strong> of <strong>{{ total }}</strong> websites
                    </small>
                </div>
                <div>
                    {% if search_query %}
                    <a href="?" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Clear Search
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Website Name</th>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Response Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for site in results %}
                        <tr class="{% if site.status == 'down' %}table-danger{% endif %}">
                            <td class="text-muted">{{ forloop.counter }}</td>
                            
                            <!-- Website Name Column with Read More -->
                            <td>
                                <div class="website-content">
                                    <!-- Name -->
                                    <h6 class="mb-1">
                                        <i class="fas fa-landmark me-1 text-secondary"></i>
                                        {{ site.name|truncatechars:30 }}
                                        {% if site.name|length > 30 %}
                                        <a href="#" class="text-primary ms-1" 
                                           data-bs-toggle="collapse" 
                                           data-bs-target="#fullName{{ forloop.counter }}"
                                           onclick="event.preventDefault();">
                                            <small><i class="fas fa-chevron-down"></i></small>
                                        </a>
                                        {% endif %}
                                    </h6>
                                    
                                    {% if site.name|length > 30 %}
                                    <div class="collapse" id="fullName{{ forloop.counter }}">
                                        <div class="alert alert-light p-2 mb-2 small">
                                            <strong>Full Name:</strong> {{ site.name }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- URL -->
                            <td>
                                <div class="url-section">
                                    <a href="{{ site.url }}" target="_blank" class="text-decoration-none">
                                        {{ site.url|truncatechars:40 }}
                                        <i class="fas fa-external-link-alt ms-1 small"></i>
                                    </a>
                                    {% if site.url|length > 40 %}
                                    <a href="#" class="text-primary ms-1" 
                                       data-bs-toggle="collapse" 
                                       data-bs-target="#fullUrl{{ forloop.counter }}"
                                       onclick="event.preventDefault();">
                                        <small><i class="fas fa-chevron-down"></i></small>
                                    </a>
                                    
                                    <div class="collapse" id="fullUrl{{ forloop.counter }}">
                                        <div class="alert alert-light p-2 mt-1 small">
                                            <strong>Full URL:</strong> {{ site.url }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Status -->
                            <td>
                                {% if site.status == 'up' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i> Online
                                    </span>
                                    {% if site.status_code %}
                                        <small class="d-block text-muted mt-1">HTTP {{ site.status_code }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-circle me-1"></i> Offline
                                    </span>
                                    {% if site.status_code %}
                                        <small class="d-block text-muted mt-1">HTTP {{ site.status_code }}</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            
                            <!-- Response Time / Error -->
                            <td>
                                {% if site.status == 'up' and site.response_time %}
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success bg-opacity-10 rounded-circle p-1 me-2">
                                            <i class="fas fa-bolt text-success fa-xs"></i>
                                        </div>
                                        <div>
                                            <span class="fw-bold">{{ site.response_time }}ms</span>
                                            <div class="progress mt-1" style="height: 4px; width: 80px;">
                                                <div class="progress-bar bg-success" 
                                                     role="progressbar"
                                                     aria-valuenow="{% if site.response_time %}{% widthratio site.response_time 5000 100 %}{% else %}0{% endif %}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="d-flex align-items-center">
                                        <div class="bg-danger bg-opacity-10 rounded-circle p-1 me-2">
                                            <i class="fas fa-exclamation text-danger fa-xs"></i>
                                        </div>
                                        <span class="text-danger small">{{ site.error|default:"Connection failed" }}</span>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-server fa-4x text-muted"></i>
                </div>
                <h5 class="text-muted mb-3">No Websites Found</h5>
                <p class="text-muted mb-4">
                    {% if search_query %}
                    No websites match your search "{{ search_query }}".
                    {% else %}
                    No websites have been added to monitor yet.
                    {% endif %}
                </p>
                {% if search_query %}
                <a href="?" class="btn btn-outline-primary btn-sm">
                    Clear Search
                </a>
                {% else %}
                <a href="/admin/monitor/website/add/" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>Add Website
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Offline Websites Alert -->
    {% if down_count > 0 %}
    <div class="alert alert-warning alert-dismissible fade show mt-4" role="alert">
        <div class="d-flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            </div>
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-1">
                    <strong>{{ down_count }} website{{ down_count|pluralize }} currently offline!</strong>
                </h6>
                <p class="mb-0 small">
                    The following websites need attention:
                    {% for site in results %}
                        {% if site.status == 'down' %}
                            {{ site.name }}{% if not forloop.last %}, {% endif %}
                        {% endif %}
                    {% endfor %}
                </p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Performance Summary Card -->
    <div class="card shadow border-0 mt-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>
                Performance Summary
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 col-6 mb-3">
                    <div class="card h-100 border-0">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-3">
                                    <i class="fas fa-bolt text-success fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="card-title mb-1">Fast (&lt;1s)</h6>
                            <h4 class="text-success mb-0">{{ fast_sites }}</h4>
                            <small class="text-muted">websites</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card h-100 border-0">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex p-3">
                                    <i class="fas fa-clock text-warning fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="card-title mb-1">Slow (1-3s)</h6>
                            <h4 class="text-warning mb-0">{{ slow_sites }}</h4>
                            <small class="text-muted">websites</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card h-100 border-0">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex p-3">
                                    <i class="fas fa-hourglass-end text-danger fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="card-title mb-1">Very Slow (&gt;3s)</h6>
                            <h4 class="text-danger mb-0">{{ very_slow_sites }}</h4>
                            <small class="text-muted">websites</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card h-100 border-0">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex p-3">
                                    <i class="fas fa-check-circle text-primary fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="card-title mb-1">Uptime Rate</h6>
                            <h4 class="text-primary mb-0">{{ uptime_percentage }}%</h4>
                            <small class="text-muted">last 24 hours</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add META refresh as backup -->
<meta http-equiv="refresh" content="60">
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh countdown
let countdown = 60;
let refreshInterval;
const countdownElement = document.getElementById('countdown');
const refreshBadge = document.getElementById('refresh-badge');

function updateCountdown() {
    countdown--;
    if (countdownElement) {
        countdownElement.textContent = countdown;
    }
    
    if (countdown <= 0) {
        countdown = 60;
        if (refreshBadge) {
            refreshBadge.innerHTML = '<i class="fas fa-sync-alt fa-spin me-1"></i> Auto-refresh: <span id="countdown">60</span>s';
        }
        
        // Get current URL and add refresh parameter
        let url = new URL(window.location.href);
        url.searchParams.set('refresh', '1');
        
        // Reload the page
        window.location.href = url.toString();
    }
}

// Start countdown timer only once
function startCountdown() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    refreshInterval = setInterval(updateCountdown, 1000);
}

// Start when page loads
document.addEventListener('DOMContentLoaded', function() {
    startCountdown();
});

// Check single website
function checkSingleWebsite(url, btn) {
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    // Simulate check
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }, 1500);
}

// Refresh all websites
function refreshAllWebsites() {
    const btn = event.currentTarget;
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    btn.disabled = true;
    
    // Reset countdown
    countdown = 60;
    if (countdownElement) {
        countdownElement.textContent = countdown;
    }
    if (refreshBadge) {
        refreshBadge.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Auto-refresh: <span id="countdown">60</span>s';
    }
    
    // Get current URL and add refresh parameter
    let url = new URL(window.location.href);
    url.searchParams.set('refresh', '1');
    
    // Reload the page
    window.location.href = url.toString();
}

// Copy URL to clipboard
function copyURL(url) {
    navigator.clipboard.writeText(url).catch(() => {
        // Silent fail
    });
}

// Handle collapse toggles
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for collapse toggles
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.dataset.bsTarget);
            if (target) {
                target.classList.toggle('show');
            }
        });
    });
    
    // Search on enter key
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.closest('form').submit();
            }
        });
    }
});

// Clear interval on page unload to prevent memory leaks
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Progress bar styling */
.progress {
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Table row hover effect */
.table tbody tr:hover {
    background-color: rgba(0,0,0,0.02);
}

/* Empty state icon */
.empty-state-icon {
    opacity: 0.7;
}

/* Badge styling */
.badge {
    padding: 0.5rem 0.75rem;
    font-weight: 500;
}

/* Card hover effect */
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1) !important;
}

/* Collapse animation */
.collapse {
    transition: all 0.2s ease;
}

.collapse:not(.show) {
    display: none;
}

.collapse.show {
    display: block;
}

/* Button group spacing */
.btn-group .btn {
    margin: 0 2px;
}

/* Countdown animation */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

#countdown {
    font-weight: bold;
    animation: pulse 1s infinite;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 2px;
        border-radius: 4px !important;
    }
    
    .table td {
        min-width: 120px;
    }
}
</style>
{% endblock %}