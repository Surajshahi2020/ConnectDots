{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-primary mb-3">News Sources</h2>
        <p class="text-muted">Fetch news from multiple sources with one click</p>
    </div>

    <!-- Simple 4-column grid -->
    <div class="row g-4">
        <!-- Techpana Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <img src="{% static 'project_images/techpana.png' %}" 
                                 alt="Techpana" 
                                 class="img-fluid" 
                                 style="height: 60px; width: auto;">
                        </div>
                        <h5 class="fw-bold mb-2">Techpana</h5>
                        <p class="text-muted small mb-3">Technology news portal</p>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-primary bg-opacity-10 text-primary">Tech</span>
                            <span class="badge bg-primary bg-opacity-10 text-primary">Latest</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100 py-2" 
                            id="techpanaBtn" 
                            onclick="fetchSource('techpana', this)">
                        <i class="fas fa-download me-2"></i>
                        Fetch News
                    </button>
                    
                    <div id="techpanaProgress" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                <span class="small">Fetching Techpana...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nagarik News Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <img src="{% static 'project_images/nagarik.png' %}" 
                                 alt="Nagarik News" 
                                 class="img-fluid" 
                                 style="height: 60px; width: auto;">
                        </div>
                        <h5 class="fw-bold mb-2">Nagarik News</h5>
                        <p class="text-muted small mb-3">Nepali news portal</p>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-danger bg-opacity-10 text-danger">नेपाली</span>
                            <span class="badge bg-danger bg-opacity-10 text-danger">National</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-danger w-100 py-2" 
                            id="nagarikBtn" 
                            onclick="fetchSource('nagariknews', this)">
                        <i class="fas fa-download me-2"></i>
                        Fetch News
                    </button>
                    
                    <div id="nagarikProgress" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-danger me-2"></div>
                                <span class="small">Fetching Nagarik...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kantipur Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <img src="{% static 'project_images/kantipur.png' %}" 
                                 alt="Kantipur News" 
                                 class="img-fluid" 
                                 style="height: 60px; width: auto;">
                        </div>
                        <h5 class="fw-bold mb-2">Kantipur News</h5>
                        <p class="text-muted small mb-3">Nepali news portal</p>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-success bg-opacity-10 text-success">नेपाली</span>
                            <span class="badge bg-success bg-opacity-10 text-success">National</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success w-100 py-2" 
                            id="kantipurBtn" 
                            onclick="fetchSource('kantipur', this)">
                        <i class="fas fa-download me-2"></i>
                        Fetch News
                    </button>
                    
                    <div id="kantipurProgress" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-success me-2"></div>
                                <span class="small">Fetching Kantipur...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kathmandu Post Card -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <img src="{% static 'project_images/kathmandu.png' %}" 
                                 alt="Kathmandu Post" 
                                 class="img-fluid" 
                                 style="height: 60px; width: auto;">
                        </div>
                        <h5 class="fw-bold mb-2">Kathmandu Post</h5>
                        <p class="text-muted small mb-3">English newspaper</p>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">English</span>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">National</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary w-100 py-2" 
                            id="kathmanduBtn" 
                            onclick="fetchSource('kathmandupost', this)">
                        <i class="fas fa-download me-2"></i>
                        Fetch News
                    </button>
                    
                    <div id="kathmanduProgress" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-secondary me-2"></div>
                                <span class="small">Fetching Kathmandu Post...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Online Khabar Card -->
        <!-- <div class="col-md-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <img src="{% static 'project_images/onlinekhabar.png' %}" 
                                 alt="Online Khabar" 
                                 class="img-fluid" 
                                 style="height: 60px; width: auto;">
                        </div>
                        <h5 class="fw-bold mb-2">Online Khabar</h5>
                        <p class="text-muted small mb-3">Digital news portal</p>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-warning bg-opacity-10 text-warning">नेपाली</span>
                            <span class="badge bg-warning bg-opacity-10 text-warning">Digital</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning w-100 py-2 text-dark" 
                            id="onlinekhabarBtn" 
                            onclick="fetchSource('onlinekhabar', this)">
                        <i class="fas fa-download me-2"></i>
                        Fetch News
                    </button>
                    
                    <div id="onlinekhabarProgress" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-warning me-2"></div>
                                <span class="small">Fetching Online Khabar...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->

    </div>
    
</div>

<!-- Simple Modals -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check me-2"></i>Success
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 id="successTitle">Fetch Completed</h5>
                <p id="successMessage" class="text-muted"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 id="errorTitle">Fetch Failed</h5>
                <p id="errorMessage" class="text-muted"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token function for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Global variable to prevent multiple simultaneous fetches
let isFetching = false;

// Function to get display name for source
function getSourceName(source) {
    const names = {
        'techpana': 'Techpana',
        'nagariknews': 'Nagarik News',
        'kantipur': 'Kantipur',
        'kathmandupost': 'Kathmandu Post',
        'onlinekhabar': 'Online Khabar',
        'all': 'All Sources'
    };
    return names[source] || source;
}

// Main fetch function
async function fetchSource(source, button) {
    console.log(`Fetching from ${source}...`);
    
    // Prevent multiple simultaneous fetches
    if (isFetching) {
        alert('Another fetch is already in progress. Please wait.');
        return;
    }
    
    isFetching = true;
    const progressId = `${source}Progress`;
    const originalText = button.innerHTML;
    
    // Disable button and show progress
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Fetching...';
    
    // Show progress indicator
    const progressElement = document.getElementById(progressId);
    if (progressElement) {
        progressElement.style.display = 'block';
    }
    
    try {
        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        
        // Make the fetch request to your Django view
        const response = await fetch("{% url 'keyboard_AutoFeed' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                source: source
            })
        });
        
        console.log('Response status:', response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                // Show success modal
                document.getElementById('successTitle').textContent = `${getSourceName(source)} Fetch Complete`;
                document.getElementById('successMessage').textContent = data.alert_message || `${getSourceName(source)} articles fetched successfully`;
                
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
            } else {
                // Show error modal
                document.getElementById('errorTitle').textContent = `${getSourceName(source)} Fetch Failed`;
                document.getElementById('errorMessage').textContent = data.alert_message || 'Failed to fetch articles';
                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();
            }
        } else {
            // Handle non-JSON response (text/html)
            const text = await response.text();
            console.log('Response text:', text.substring(0, 200));
            
            // Show success modal for non-JSON responses (assuming success)
            document.getElementById('successTitle').textContent = `${getSourceName(source)} Fetch Complete`;
            document.getElementById('successMessage').textContent = 'Articles fetched successfully!';
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        }
        
    } catch (error) {
        console.error('Fetch error:', error);
        
        // Show error modal
        document.getElementById('errorTitle').textContent = `${getSourceName(source)} Fetch Failed`;
        document.getElementById('errorMessage').textContent = error.message || 'An error occurred during fetch';
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        errorModal.show();
        
    } finally {
        // Reset button and hide progress
        button.disabled = false;
        button.innerHTML = originalText;
        if (progressElement) {
            progressElement.style.display = 'none';
        }
        isFetching = false;
    }
}

// Function to fetch all sources
async function fetchAllSources(button) {
    console.log('Fetching all sources...');
    
    if (isFetching) {
        alert('Another fetch is already in progress. Please wait.');
        return;
    }
    
    isFetching = true;
    const progressId = 'allSourcesProgress';
    const originalText = button.innerHTML;
    
    // Disable button and show progress
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Fetching All...';
    
    // Show progress indicator
    const progressElement = document.getElementById(progressId);
    if (progressElement) {
        progressElement.style.display = 'block';
    }
    
    try {
        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        
        // Make the fetch request
        const response = await fetch("{% url 'keyboard_AutoFeed' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                source: 'all'
            })
        });
        
        console.log('Response status:', response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                document.getElementById('successTitle').textContent = 'All Sources Fetch Complete';
                document.getElementById('successMessage').textContent = data.alert_message || 'All articles fetched successfully';
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
            } else {
                document.getElementById('errorTitle').textContent = 'All Sources Fetch Failed';
                document.getElementById('errorMessage').textContent = data.alert_message || 'Failed to fetch articles';
                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();
            }
        } else {
            // Handle non-JSON response
            const text = await response.text();
            console.log('Response text:', text.substring(0, 200));
            
            document.getElementById('successTitle').textContent = 'All Sources Fetch Complete';
            document.getElementById('successMessage').textContent = 'All articles fetched successfully!';
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        }
        
    } catch (error) {
        console.error('Fetch error:', error);
        
        document.getElementById('errorTitle').textContent = 'All Sources Fetch Failed';
        document.getElementById('errorMessage').textContent = error.message || 'An error occurred during fetch';
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        errorModal.show();
        
    } finally {
        // Reset button and hide progress
        button.disabled = false;
        button.innerHTML = originalText;
        if (progressElement) {
            progressElement.style.display = 'none';
        }
        isFetching = false;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('News Fetcher loaded');
    
    // Simple hover effects
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Card hover effect
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.transition = 'transform 0.2s ease';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add keyboard shortcuts (optional)
    document.addEventListener('keydown', function(event) {
        if (event.altKey) {
            let button;
            switch(event.key) {
                case '1':
                    event.preventDefault();
                    button = document.getElementById('techpanaBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchSource('techpana', button);
                    }
                    break;
                case '2':
                    event.preventDefault();
                    button = document.getElementById('nagarikBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchSource('nagariknews', button);
                    }
                    break;
                case '3':
                    event.preventDefault();
                    button = document.getElementById('kantipurBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchSource('kantipur', button);
                    }
                    break;
                case '4':
                    event.preventDefault();
                    button = document.getElementById('kathmanduBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchSource('kathmandu_post', button);
                    }
                    break;
                case '5':
                    event.preventDefault();
                    button = document.getElementById('onlinekhabarBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchSource('onlinekhabar', button);
                    }
                    break;
                case 'a':
                case 'A':
                    event.preventDefault();
                    button = document.getElementById('allSourcesBtn');
                    if (button && !button.disabled && !isFetching) {
                        fetchAllSources(button);
                    }
                    break;
            }
        }
    });
});
</script>

<style>
/* Simple, clean styling */
.container {
    max-width: 1200px;
}

.card {
    border-radius: 12px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.btn {
    border-radius: 8px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.badge {
    border-radius: 20px;
    padding: 4px 10px;
    font-weight: 500;
}

.alert-light {
    border-radius: 8px;
    background-color: #f8f9fa;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%) !important;
}

/* Modal styling */
.modal-content {
    border-radius: 12px;
    border: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .card-body {
        padding: 1.5rem !important;
    }
    
    .row.g-4 {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }
    
    .col-md-6 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}

/* Simple animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.container {
    animation: fadeIn 0.5s ease;
}

/* Clean loading spinner */
.spinner-border {
    width: 1rem;
    height: 1rem;
}

/* Ensure consistent card heights */
.card-body {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
</style>

{% endblock %}