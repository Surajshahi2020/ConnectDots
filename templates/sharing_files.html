<!-- templates/files/sharing.html -->
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}File Sharing{% endblock %}

{% block content %}
<!-- ðŸ“ Category Filter Bar -->
<div class="card border-0 mb-4">
  <div class="card-body">
    <form method="get" class="d-flex flex-wrap gap-3 align-items-end">
      {% for value, label in file_types %}
        <div class="form-check">
          <input 
            class="form-check-input" 
            type="checkbox" 
            name="file_type" 
            value="{{ value }}" 
            id="type_{{ value }}"
            {% if value in selected_types %}checked{% endif %}
          >
          <label class="form-check-label" for="type_{{ value }}">
            <i class="fas fa-file-{{ value|lower }} me-1"></i> {{ label }}
          </label>
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-primary btn-sm">
        <i class="fas fa-filter me-1"></i> Filter Files
      </button>
      <a href="{% url 'sharing_files' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-redo me-1"></i> Clear Filters
      </a>
    </form>
  </div>
</div>

<!-- ðŸ“¤ Upload File Card -->
<div class="card border-primary mb-4">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="fas fa-cloud-upload-alt me-2"></i> 
      Upload New File
    </h5>
  </div>
  <div class="card-body">
    <form method="POST" enctype="multipart/form-data" class="row g-3">
      {% csrf_token %}
      <div class="col-md-6">
        <label for="fileInput" class="form-label">Select File</label>
        <input class="form-control" type="file" id="fileInput" name="file" required>
        <div class="form-text">
          Max size: 10MB. Allowed: PDF, DOC, TXT, JPG, PNG, ZIP, etc.
        </div>
      </div>
      <div class="col-md-4">
        <label for="shareWith" class="form-label">Share With (Optional)</label>
        <input type="text" class="form-control" id="shareWith" name="share_with" 
               placeholder="Enter usernames or emails...">
        <div class="form-text">Separate multiple with commas</div>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-upload me-1"></i> Upload
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ðŸ“ Shared Files Table -->
<div class="card border-0">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="fas fa-folder-open me-2"></i> 
      Shared Files ({{ files.paginator.count|default:"0" }} files)
    </h5>
    <div>
      <button class="btn btn-sm btn-light" onclick="selectAllFiles()">
        <i class="fas fa-check-square me-1"></i> Select All
      </button>
      <button class="btn btn-sm btn-light ms-2" onclick="downloadSelected()">
        <i class="fas fa-download me-1"></i> Download Selected
      </button>
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="filesTable">
        <thead class="table-light">
          <tr>
            <th style="width: 4%;">
              <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
            </th>
            <th style="width: 10%;">Type</th>
            <th style="width: 25%;">Filename</th>
            <th style="width: 10%;">Size</th>
            <th style="width: 15%;">Uploaded By</th>
            <th style="width: 15%;">Shared With</th>
            <th style="width: 10%;">Uploaded</th>
            <th style="width: 11%;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
          <tr>
            <!-- Checkbox -->
            <td>
              <input type="checkbox" class="file-checkbox" value="{{ file.id }}">
            </td>
            
            <!-- File Type Icon -->
            <td>
              {% if file.extension == 'pdf' %}
                <i class="fas fa-file-pdf text-danger fa-lg"></i>
              {% elif file.extension == 'doc' or file.extension == 'docx' %}
                <i class="fas fa-file-word text-primary fa-lg"></i>
              {% elif file.extension == 'jpg' or file.extension == 'jpeg' or file.extension == 'png' %}
                <i class="fas fa-file-image text-success fa-lg"></i>
              {% elif file.extension == 'zip' or file.extension == 'rar' %}
                <i class="fas fa-file-archive text-warning fa-lg"></i>
              {% elif file.extension == 'txt' %}
                <i class="fas fa-file-alt text-secondary fa-lg"></i>
              {% else %}
                <i class="fas fa-file text-muted fa-lg"></i>
              {% endif %}
              <small class="text-muted d-block">{{ file.extension|upper }}</small>
            </td>
            
            <!-- Filename -->
            <td>
              <div class="expandable-cell" 
                   data-full="{{ file.name }}" 
                   data-truncated="{{ file.name|truncatechars:30 }}">
                <strong>{{ file.name|truncatechars:30 }}</strong>
                {% if file.description %}
                <div class="text-muted small mt-1">
                  {{ file.description|truncatechars:40 }}
                </div>
                {% endif %}
              </div>
            </td>

            <!-- File Size -->
            <td>
              <span class="badge bg-light text-dark">
                {{ file.get_file_size_display }}
              </span>
            </td>

            <!-- Uploaded By -->
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-user-circle me-2 text-primary"></i>
                <div class="expandable-cell" 
                     data-full="{{ file.uploaded_by.username }} ({{ file.uploaded_by.email }})" 
                     data-truncated="{{ file.uploaded_by.username|truncatechars:15 }}">
                  {{ file.uploaded_by.username|truncatechars:15 }}
                  {% if file.uploaded_by == request.user %}
                    <span class="badge bg-success ms-1">You</span>
                  {% endif %}
                </div>
              </div>
            </td>

            <!-- Shared With -->
            <td>
              {% if file.shared_with.all %}
                <div class="expandable-cell" 
                     data-full="{% for user in file.shared_with.all %}{{ user.username }}{% if not forloop.last %}, {% endif %}{% endfor %}" 
                     data-truncated="{{ file.shared_with.count }} user{{ file.shared_with.count|pluralize }}">
                  <span class="badge bg-info">
                    {{ file.shared_with.count }} user{{ file.shared_with.count|pluralize }}
                  </span>
                </div>
              {% else %}
                <span class="badge bg-secondary">Private</span>
              {% endif %}
            </td>

            <!-- Upload Date -->
            <td>
              {% load tz %}
              {% timezone "Asia/Kathmandu" %}
                <div class="expandable-cell" 
                     data-full="{{ file.uploaded_at|date:'Y-m-d H:i:s' }}" 
                     data-truncated="{{ file.uploaded_at|date:'M d, Y' }}">
                  {{ file.uploaded_at|date:"M d, Y" }}
                  <small class="d-block text-muted">{{ file.uploaded_at|date:"H:i" }}</small>
                </div>
              {% endtimezone %}
            </td>

            <!-- Actions -->
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'download_shared_file' file.id %}" class="btn btn-outline-primary" title="Download">
                  <i class="fas fa-download"></i>
                </a>
                {% if file.uploaded_by == request.user %}
                  <button type="button" class="btn btn-outline-success" onclick="shareFile('{{ file.id }}')" title="Share">
                    <i class="fas fa-share-alt"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger" onclick="deleteFile('{{ file.id }}')" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-5 text-muted">
              <i class="fas fa-folder-open fa-3x mb-3"></i>
              <h5>No files shared yet</h5>
              <p>Upload your first file using the form above!</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ðŸ“„ Pagination -->
    {% if files.has_other_pages %}
      <div class="card-footer bg-light d-flex justify-content-center">
        <nav aria-label="File pagination">
          <ul class="pagination pagination-sm mb-0">
            {% if files.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% for type in selected_types %}&file_type={{ type }}{% endfor %}">
                  <i class="fas fa-angle-double-left"></i> First
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ files.previous_page_number }}{% for type in selected_types %}&file_type={{ type }}{% endfor %}">
                  <i class="fas fa-angle-left"></i> Prev
                </a>
              </li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">
                Page {{ files.number }} of {{ files.paginator.num_pages }}
              </span>
            </li>

            {% if files.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ files.next_page_number }}{% for type in selected_types %}&file_type={{ type }}{% endfor %}">
                  Next <i class="fas fa-angle-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ files.paginator.num_pages }}{% for type in selected_types %}&file_type={{ type }}{% endfor %}">
                  Last <i class="fas fa-angle-double-right"></i>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</div>

<!-- ðŸ” Search and JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const table = document.querySelector('#filesTable');
    if (!table) return;

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control form-control-sm mb-3';
    searchInput.placeholder = 'ðŸ” Search files by name, user, or type...';

    const tableContainer = table.closest('.table-responsive') || table.parentNode;
    tableContainer.parentNode.insertBefore(searchInput, tableContainer);

    searchInput.addEventListener('input', function() {
      const term = this.value.toLowerCase().trim();
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });

    // Focus search on '/' key
    document.addEventListener('keydown', function(e) {
      if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
        e.preventDefault();
        searchInput.focus();
      }
    });

    // Expandable cells functionality
    document.addEventListener('click', function(e) {
      if (e.target.closest('.expandable-cell')) {
        const cell = e.target.closest('.expandable-cell');
        const isExpanded = cell.classList.contains('expanded');
        
        if (isExpanded) {
          cell.innerHTML = cell.dataset.truncated;
          cell.classList.remove('expanded');
        } else {
          cell.innerHTML = cell.dataset.full;
          cell.classList.add('expanded');
        }
      }
    });
  });

  // File selection functions
  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAll.checked;
    });
  }

  function selectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    document.getElementById('selectAll').checked = true;
  }

  function getSelectedFileIds() {
    const selectedFiles = [];
    document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
      selectedFiles.push(checkbox.value);
    });
    return selectedFiles;
  }

  function downloadSelected() {
    const selectedFiles = getSelectedFileIds();
    
    if (selectedFiles.length === 0) {
      alert('Please select files to download.');
      return;
    }
    
    // Download each file individually
    selectedFiles.forEach(fileId => {
      window.open(`/files/download/${fileId}/`, '_blank');
    });
  }

  function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file?')) {
      // Redirect to the delete endpoint
      window.location.href = `/files/delete/${fileId}/`;
    }
  }

  function shareFile(fileId) {
    const shareWith = prompt('Enter usernames or emails to share with (comma-separated):');
    if (shareWith) {
      // Create form and submit
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/files/share/${fileId}/`;
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      const shareInput = document.createElement('input');
      shareInput.type = 'hidden';
      shareInput.name = 'share_with';
      shareInput.value = shareWith;
      form.appendChild(shareInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>

<!-- âœ… Expandable Cells Styles -->
<style>
.expandable-cell {
  cursor: pointer;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 4px 0;
  max-height: 3em;
  line-height: 1.5em;
  transition: all 0.2s;
}
.expandable-cell.expanded {
  white-space: pre-wrap;
  word-break: break-word;
  max-height: none;
  background-color: #f8f9fa;
  border-radius: 4px;
  padding: 8px;
}
.expandable-cell:hover:not(.expanded) {
  background-color: #e9ecef;
}
.expandable-cell:hover:not(.expanded)::after {
  content: " (click to expand)";
  color: #0d6efd;
  font-size: 0.8em;
  margin-left: 4px;
  opacity: 0.7;
}

/* File type specific colors */
.fa-file-pdf { color: #f40f02; }
.fa-file-word { color: #2b579a; }
.fa-file-image { color: #28a745; }
.fa-file-archive { color: #fd7e14; }
.fa-file-alt { color: #6c757d; }
.fa-file { color: #adb5bd; }

/* Responsive adjustments */
@media (max-width: 768px) {
  .btn-group {
    flex-direction: column;
  }
  .btn-group .btn {
    margin-bottom: 2px;
    width: 100%;
  }
}
</style>

{% include 'sweet_alert.html' %}

{% endblock %}